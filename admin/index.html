<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Civic Admin Portal (Demo)</title>
    <style>
      body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin:0; background:#f6f7fb; }
      header { background:#0d6efd; color:white; padding:16px 20px; font-weight:600; }
      .wrap { max-width: 1100px; margin: 20px auto; padding: 0 16px; }
      .toolbar { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
      .toolbar input, .toolbar select { padding:8px 10px; border:1px solid #d0d7de; border-radius:8px; background:white; }
      .grid { display:grid; grid-template-columns: 340px 1fr; gap:16px; }
      .card { background:white; border:1px solid #e5e7eb; border-radius:12px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
      .card h3 { margin:0; padding:12px 14px; border-bottom:1px solid #f0f0f0; font-size:14px; color:#334155; }
      .list { max-height: 70vh; overflow:auto; }
      .item { padding:12px 14px; border-bottom:1px solid #f5f5f5; cursor:pointer; }
      .item:hover { background:#f9fafb; }
      .pill { padding:2px 8px; border-radius:999px; font-size:11px; display:inline-block; margin-left:6px; }
      .pill.warn { background:#fff3cd; color:#856404; }
      .pill.ok { background:#d4edda; color:#155724; }
      .map { height: 70vh; }
      .row { padding:12px 14px; }
      .muted { color:#6b7280; font-size:13px; }
      .split { display:flex; gap:10px; }
      .split > * { flex:1; }
      button { background:#0d6efd; color:white; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }
      button.ghost { background:white; color:#0d6efd; border:1px solid #0d6efd; }
      .media { max-width:100%; border-radius:8px; margin-top:10px; }
    </style>
  </head>
  <body>
    <header>Civic Admin Portal (Demo)</header>
    <div class="wrap">
      <div class="toolbar">
        <input id="search" placeholder="Search text or address" />
        <select id="status">
          <option value="">All Statuses</option>
          <option>new</option>
          <option>routed</option>
          <option>in_progress</option>
          <option>resolved</option>
        </select>
        <select id="type">
          <option value="">All Types</option>
          <option>Garbage</option>
          <option>Pothole</option>
          <option>Traffic</option>
          <option>Noise</option>
        </select>
        <button id="refresh">Refresh</button>
      </div>
      <div class="grid">
        <div class="card">
          <h3>Incoming Reports</h3>
          <div id="list" class="list"></div>
        </div>
        <div class="card">
          <h3>Details</h3>
          <div class="row" id="details">Select a report from the list.</div>
        </div>
      </div>
    </div>

    <script>
      // Try to use the same host as the device is running on
      let API = '';
      try {
        const h = location.hostname;
        if (h && h !== 'localhost' && h !== '127.0.0.1') {
          API = `http://${h}:4000`;
        } else {
          API = 'http://localhost:4000';
        }
      } catch { API = 'http://localhost:4000'; }
      const listEl = document.getElementById('list');
      const detailsEl = document.getElementById('details');
      const searchEl = document.getElementById('search');
      const statusEl = document.getElementById('status');
      const typeEl = document.getElementById('type');
      const refreshBtn = document.getElementById('refresh');

      async function fetchReports() {
        const params = new URLSearchParams();
        if (searchEl.value) params.set('search', searchEl.value);
        if (statusEl.value) params.set('status', statusEl.value);
        if (typeEl.value) params.set('type', typeEl.value);
        const res = await fetch(`${API}/reports?${params.toString()}`);
        const data = await res.json();
        renderList(data);
      }

      function renderList(reports) {
        listEl.innerHTML = '';
        reports.forEach(r => {
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div><strong>${escapeHtml(r.type)}</strong>
              <span class="pill ${r.status === 'resolved' ? 'ok' : 'warn'}">${escapeHtml(r.status)}</span>
            </div>
            <div class="muted">${escapeHtml(r.address || '(no address)')}</div>
            <div class="muted">${new Date(r.createdAt).toLocaleString()}</div>
          `;
          div.onclick = () => showDetails(r);
          listEl.appendChild(div);
        });
      }

      function showDetails(r) {
        detailsEl.innerHTML = `
          <div class="split">
            <div>
              <div><strong>Type:</strong> ${escapeHtml(r.type)}</div>
              <div><strong>Status:</strong> ${escapeHtml(r.status)}</div>
              <div><strong>Priority:</strong> ${escapeHtml(r.priority || 'normal')}</div>
              <div><strong>Address:</strong> ${escapeHtml(r.address || '(no address)')}</div>
              <div><strong>Created:</strong> ${new Date(r.createdAt).toLocaleString()}</div>
              <div><strong>Description:</strong> <div class="muted">${escapeHtml(r.description || '')}</div></div>
              <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                <button onclick="routeReport('${r.id}')">Auto-Route</button>
                <button class="ghost" onclick="markStatus('${r.id}', 'in_progress')">Start</button>
                <button class="ghost" onclick="markStatus('${r.id}', 'resolved')">Resolve</button>
                <button class="ghost" onclick="rejectReport('${r.id}')">Reject</button>
              </div>
            </div>
            <div>
              ${r.mediaUrl ? `<img class="media" src="${API}${r.mediaUrl}" />` : ''}
            </div>
          </div>
        `;
      }

      async function routeReport(id) {
        await fetch(`${API}/route/${id}`, { method: 'POST' });
        await fetchReports();
      }
      async function markStatus(id, status) {
        await fetch(`${API}/reports/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) });
        await fetchReports();
      }

      async function rejectReport(id) {
        const reason = prompt('Reason for rejection?');
        await fetch(`${API}/reports/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'rejected' }) });
        await fetchReports();
      }

      function escapeHtml(str) { return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }

      refreshBtn.onclick = fetchReports;
      statusEl.onchange = fetchReports;
      typeEl.onchange = fetchReports;
      searchEl.oninput = (e) => { if (e.target.value.length === 0) fetchReports(); };

      // Live updates via SSE
      try {
        const es = new EventSource(`${API}/events`);
        es.onmessage = () => fetchReports();
      } catch (e) { console.warn('SSE failed', e); }

      fetchReports();
    </script>
  </body>
</html>


